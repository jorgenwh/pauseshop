name: 🔍 Code Quality & Build

on:
  # Run on all pushes to any branch EXCEPT main/develop
  push:
    branches-ignore: [main, develop]
  
  # Run on pull requests TO main/develop
  pull_request:
    branches: [main, develop]
    
  workflow_dispatch:

jobs:
  quality-check:
    name: Code Quality & Build Check
    runs-on: ubuntu-latest
    
    steps:
      - name: 📥 Checkout Code
        uses: actions/checkout@v4
        
      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: 📦 Install Dependencies
        run: npm ci
        
      - name: 🔍 Lint Extension
        run: |
          echo "::group::Extension Linting"
          npm run lint --workspace=extension
          echo "::endgroup::"
        
      - name: 🔍 Lint Server
        run: |
          echo "::group::Server Linting"
          npm run lint --workspace=server
          echo "::endgroup::"
        
      - name: 🔧 TypeScript Check - Extension
        run: |
          echo "::group::TypeScript Check - Extension"
          cd extension
          npx tsc --noEmit --pretty
          echo "::endgroup::"
        
      - name: 🔧 TypeScript Check - Server
        run: |
          echo "::group::TypeScript Check - Server"
          cd server
          npx tsc --noEmit --pretty
          echo "::endgroup::"
        
      - name: 🏗️ Build Extension
        run: |
          echo "::group::Building Extension"
          npm run build --workspace=extension
          echo "Extension build completed successfully!"
          echo "::endgroup::"
        
      - name: 🏗️ Build Server
        run: |
          echo "::group::Building Server"
          npm run build --workspace=server
          echo "Server build completed successfully!"
          echo "::endgroup::"
        
      - name: 📊 Build Artifacts Check
        run: |
          echo "::group::Verifying Build Artifacts"
          
          # Check extension build output
          if [ -d "extension/dist" ]; then
            echo "✅ Extension dist/ directory created"
            ls -la extension/dist/
          else
            echo "❌ Extension dist/ directory not found"
            exit 1
          fi
          
          # Check server build output
          if [ -d "server/dist" ]; then
            echo "✅ Server dist/ directory created"
            ls -la server/dist/
          else
            echo "❌ Server dist/ directory not found"
            exit 1
          fi
          
          echo "::endgroup::"

  quality-summary:
    name: 📊 Quality Summary
    runs-on: ubuntu-latest
    needs: quality-check
    if: always()
    
    steps:
      - name: ✅ Success
        if: needs.quality-check.result == 'success'
        run: |
          echo "🎉 All quality checks and builds passed!"
          echo "✅ Extension linting: PASSED"
          echo "✅ Server linting: PASSED"  
          echo "✅ TypeScript compilation: PASSED"
          echo "✅ Extension build: PASSED"
          echo "✅ Server build: PASSED"
          echo ""
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "🚀 Branch '${{ github.ref_name }}' is ready for pull request to main!"
          else
            echo "🚀 Pull request is ready to merge!"
          fi
          
      - name: ❌ Failure
        if: needs.quality-check.result != 'success'
        run: |
          echo "❌ Quality checks or builds failed!"
          echo ""
          echo "To fix locally:"
          echo "  npm run lint              # Check linting errors"
          echo "  npm run lint:fix          # Auto-fix what's possible"
          echo "  npm run build             # Test full build process"
          echo "  cd extension && npx tsc   # Check extension types"
          echo "  cd server && npx tsc      # Check server types"
          echo ""
          if [ "${{ github.event_name }}" = "push" ]; then
            echo "❌ Fix these issues before creating a pull request to main."
          else
            echo "❌ Pull request cannot be merged until these issues are resolved."
          fi
          exit 1